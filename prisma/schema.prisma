// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model BeagleProgram {
  id                        String   @id @default(cuid())
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  // Property manager details
  propertyManagerName       String
  propertyManagerSlug       String   @unique // used in URL, e.g. "santa-fe-property-management"

  // Insurance verification link (required)
  insuranceVerificationUrl  String

  // Optional embedded webview URL
  // If provided, displays as iframe on the public program page
  webviewUrl                String?  // e.g., "https://tools.yourrenterskit.com/renter-benefits/8omnj4cltuawsbsfzz"

  // Program configuration - admin selects which products to offer
  // selectedProducts: array of product objects with prices like [{ id: "product_100k", name: "...", price: "$15/month" }]
  selectedProducts          Json     @default("[]") // array of selected products with prices

  // Publication status
  isPublished               Boolean  @default(false)

  // Optional form for opt-out functionality
  form                      Form?

  // Upgrade selections
  upgradeSelections         UpgradeSelection[]

  // Customizable notice text (all optional - defaults to hardcoded values if null)
  noticeTitle               String?  // e.g., "Insurance Verification" - defaults to "Insurance Verification - {PM Name}"
  noticeIntroText           String?  // Main intro paragraph
  noticeInsuranceText       String?  // "Already have renters insurance?" section text
  insuranceNotRequired      Boolean  @default(false) // If true, hides the insurance section entirely

  // Program tags for dashboard display
  tags                      String[] @default([]) // e.g., ["Both"], ["TLW"], ["Renters Kit"]

  @@index([propertyManagerSlug])
  @@index([isPublished])
}

model Form {
  id                                  String   @id @default(cuid())
  createdAt                           DateTime @default(now())
  updatedAt                           DateTime @updatedAt

  beagleProgramId                     String   @unique
  beagleProgram                       BeagleProgram @relation(fields: [beagleProgramId], references: [id], onDelete: Cascade)

  // Opt-out configuration - admin checks these boxes
  tenantLiabilityWaiverCanOptOut      Boolean  @default(false)
  rentersKitCanOptOut                 Boolean  @default(false)

  // Opt-in configuration - admin checks these boxes
  tenantLiabilityWaiverCanOptIn       Boolean  @default(false)
  rentersKitCanOptIn                  Boolean  @default(false)

  // Customizable opt-in form text
  optInFormTitle                      String?  // e.g., "Interested in using Beagle?"
  optInFormSubtitle                   String?  // e.g., "Tell us which products you'd like to explore..."

  // Responses from tenants
  optOutResponses                     OptOutResponse[] @relation("OptOutResponses")
  optInResponses                      OptInResponse[]  @relation("OptInResponses")

  @@index([beagleProgramId])
}

model OptOutResponse {
  id                                  String   @id @default(cuid())
  createdAt                           DateTime @default(now())

  formId                              String
  form                                Form     @relation("OptOutResponses", fields: [formId], references: [id], onDelete: Cascade)

  firstName                           String
  lastName                            String
  phoneNumber                         String?  // Contact phone number

  // Track which products they opted out of
  optedOutOfTenantLiabilityWaiver     Boolean  @default(false)
  optedOutOfRentersKit                Boolean  @default(false)

  // Track selected upgrades (optional)
  selectedUpgrade                     String?  // e.g., "upgrade_5k", "upgrade_10k", "upgrade_20k", or null
  selectedUpgradePrice                String?  // e.g., "+$2", "+$4", "+$6"

  @@index([formId])
}

model OptInResponse {
  id                                  String   @id @default(cuid())
  createdAt                           DateTime @default(now())

  formId                              String
  form                                Form     @relation("OptInResponses", fields: [formId], references: [id], onDelete: Cascade)

  firstName                           String
  lastName                            String
  phoneNumber                         String?  // Contact phone number

  // Track which products they opted in to
  optedInToTenantLiabilityWaiver      Boolean  @default(false)
  optedInToRentersKit                 Boolean  @default(false)

  @@index([formId])
}

model UpgradeSelection {
  id                                  String   @id @default(cuid())
  createdAt                           DateTime @default(now())

  beagleProgramId                     String
  beagleProgram                       BeagleProgram @relation(fields: [beagleProgramId], references: [id], onDelete: Cascade)

  firstName                           String
  lastName                            String
  phoneNumber                         String?  // Contact phone number

  // Track selected upgrade
  selectedUpgrade                     String   // e.g., "upgrade_5k", "upgrade_10k", "upgrade_20k"
  selectedUpgradePrice                String   // e.g., "+$2", "+$4", "+$6"

  @@index([beagleProgramId])
}

model SmsCampaignLog {
  id                                  String   @id @default(cuid())
  createdAt                           DateTime @default(now())

  // Admin user who initiated the campaign
  adminEmail                          String

  // Campaign metadata
  totalRecipients                     Int      // Total number of recipients attempted
  successfulSends                     Int      @default(0) // Number of successful sends
  failedSends                         Int      @default(0) // Number of failed sends

  // Message content (optional, for audit trail)
  messagePreview                      String?  // First 100 chars of the message
  
  // Campaign status
  status                              String   // "pending", "in_progress", "completed", "failed"

  @@index([adminEmail])
  @@index([createdAt])
}

